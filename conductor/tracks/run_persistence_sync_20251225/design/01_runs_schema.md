# Runs Table Schema Design

## Overview
The `runs` table is the central repository for user activity data. It is designed to support high-throughput ingestion, reliable idempotency, and efficient querying for history and analytics.

## Schema Definition

```sql
CREATE TABLE runs (
    -- Primary Key: Client-generated UUID for idempotency
    id UUID PRIMARY KEY,

    -- Foreign Key: User who performed the run
    -- Assumes a 'users' table exists. If not, this is a placeholder.
    user_id UUID NOT NULL, 

    -- Temporal Data
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    duration INTEGER NOT NULL, -- Duration in seconds

    -- Spatial & Metric Data
    distance DOUBLE PRECISION NOT NULL, -- Distance in meters
    activity_type VARCHAR(50) NOT NULL DEFAULT 'RUN', -- Extensible for future types
    
    -- Visualization
    -- Simplified encoded polyline for quick map rendering (e.g., Google Polyline Algorithm)
    polyline TEXT, 

    -- State & Reconciliation
    -- 'synced': Normal successful sync
    -- 'overlapping': Flagged as overlapping with another run
    -- 'flagged': Marked for review by anti-gaming or other logic
    status VARCHAR(20) NOT NULL DEFAULT 'synced',

    -- Metadata
    -- flexible storage for device info, app version, etc.
    metadata JSONB DEFAULT '{}',

    -- System Timestamps
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

## Columns Description

| Column | Type | Description |
| :--- | :--- | :--- |
| `id` | `UUID` | The unique identifier for the run. Generated by the client to ensure idempotency. |
| `user_id` | `UUID` | Reference to the user. |
| `start_time` | `TIMESTAMPTZ` | The start time of the run (UTC). |
| `end_time` | `TIMESTAMPTZ` | The end time of the run (UTC). |
| `duration` | `INTEGER` | Total elapsed time in seconds. |
| `distance` | `DOUBLE PRECISION` | Total distance covered in meters. |
| `activity_type` | `VARCHAR` | Type of activity (e.g., 'RUN', 'WALK'). |
| `polyline` | `TEXT` | Encoded polyline string for lightweight visualization. |
| `status` | `VARCHAR` | Lifecycle status of the run record on the backend. |
| `metadata` | `JSONB` | Additional context (e.g., `{ "device": "iPhone 13", "os": "iOS 17" }`). |
| `created_at` | `TIMESTAMPTZ` | When the record was inserted into the database. |
| `updated_at` | `TIMESTAMPTZ` | When the record was last updated. |

## Design Decisions

1.  **UUID as Primary Key:** We use the client-generated UUID as the primary key. This automatically enforces the "exactly once" constraint. Any attempt to insert a run with the same ID will fail at the database level (or can be handled gracefully with `ON CONFLICT DO NOTHING`).
2.  **`polyline` Column:** Storing the simplified polyline directly in the table allows for fast retrieval when listing history without needing to fetch the heavy raw GPS data.
3.  **`status` Column:** Used to manage runs that are technically valid but have business logic issues (like overlaps).
4.  **`metadata` JSONB:** Allows for future-proofing against new client-side metrics without altering the schema.
